<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="top.tradesystem.krx.repository.KrxDailyPriceMapper">

    <resultMap id="KrxDailyPriceRowMap" type="top.tradesystem.krx.dto.KrxDailyPriceRow">
        <constructor>
            <arg column="bas_dd"        javaType="java.lang.String"/>
            <arg column="market"        javaType="java.lang.String"/>
            <arg column="isu_cd"        javaType="java.lang.String"/>
            <arg column="isu_nm"        javaType="java.lang.String"/>
            <arg column="sect_tp_nm"    javaType="java.lang.String"/>
            <arg column="tdd_clsprc"    javaType="java.math.BigDecimal"/>
            <arg column="cmpprevdd_prc" javaType="java.math.BigDecimal"/>
            <arg column="fluc_rt"       javaType="java.math.BigDecimal"/>
            <arg column="tdd_opnprc"    javaType="java.math.BigDecimal"/>
            <arg column="tdd_hgprc"     javaType="java.math.BigDecimal"/>
            <arg column="tdd_lwprc"     javaType="java.math.BigDecimal"/>
            <arg column="acc_trdvol"    javaType="java.lang.Long"/>
            <arg column="acc_trdval"    javaType="java.math.BigDecimal"/>
            <arg column="mktcap"        javaType="java.math.BigDecimal"/>
            <arg column="list_shrs"     javaType="java.lang.Long"/>
        </constructor>
    </resultMap>

    <select id="findByBasDdAndMarket" resultMap="KrxDailyPriceRowMap">
        SELECT
        bas_dd, market, isu_cd, isu_nm, sect_tp_nm,
        tdd_clsprc, cmpprevdd_prc, fluc_rt,
        tdd_opnprc, tdd_hgprc, tdd_lwprc,
        acc_trdvol, acc_trdval, mktcap, list_shrs
        FROM krx_daily_price
        WHERE bas_dd = #{basDd}
        AND market = #{market}
        ORDER BY acc_trdval DESC
    </select>

    <select id="findByBasDdAndCode" resultMap="KrxDailyPriceRowMap">
        SELECT
        bas_dd, market, isu_cd, isu_nm, sect_tp_nm,
        tdd_clsprc, cmpprevdd_prc, fluc_rt,
        tdd_opnprc, tdd_hgprc, tdd_lwprc,
        acc_trdvol, acc_trdval, mktcap, list_shrs
        FROM krx_daily_price
        WHERE bas_dd = #{basDd}
        AND isu_cd = #{code}
        LIMIT 1
    </select>

    <insert id="upsertBatch">
        INSERT INTO krx_daily_price (
        bas_dd, market, isu_cd, isu_nm, sect_tp_nm,
        tdd_clsprc, cmpprevdd_prc, fluc_rt,
        tdd_opnprc, tdd_hgprc, tdd_lwprc,
        acc_trdvol, acc_trdval, mktcap, list_shrs
        )
        VALUES
        <foreach collection="rows" item="r" separator=",">
            (
            #{r.basDd}, #{r.market}, #{r.isuCd}, #{r.isuNm}, #{r.sectTpNm},
            #{r.tddClsprc}, #{r.cmpprevddPrc}, #{r.flucRt},
            #{r.tddOpnprc}, #{r.tddHgprc}, #{r.tddLwprc},
            #{r.accTrdvol}, #{r.accTrdval}, #{r.mktcap}, #{r.listShrs}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        market        = VALUES(market),
        isu_nm        = VALUES(isu_nm),
        sect_tp_nm    = VALUES(sect_tp_nm),
        tdd_clsprc    = VALUES(tdd_clsprc),
        cmpprevdd_prc = VALUES(cmpprevdd_prc),
        fluc_rt       = VALUES(fluc_rt),
        tdd_opnprc    = VALUES(tdd_opnprc),
        tdd_hgprc     = VALUES(tdd_hgprc),
        tdd_lwprc     = VALUES(tdd_lwprc),
        acc_trdvol    = VALUES(acc_trdvol),
        acc_trdval    = VALUES(acc_trdval),
        mktcap        = VALUES(mktcap),
        list_shrs     = VALUES(list_shrs),
        updated_at    = CURRENT_TIMESTAMP
    </insert>

</mapper>
